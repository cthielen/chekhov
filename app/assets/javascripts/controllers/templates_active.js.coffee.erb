Chekhov.controller "TemplatesActiveIndexCtrl", @TemplatesActiveIndexCtrl = ($scope, $modal, $location, Checklists, User, ChecklistCategories, $rootScope) ->
  $scope.loaded = false
  $scope.error = null

  $scope.startDate = new Date()
  $scope.startDate.setMonth($scope.startDate.getMonth() - 1)

  $scope.endDate = new Date()

  $scope.display =
    inProgress: true
    archived: false

  Checklists.query {},
    (data) ->
      # Success
      $scope.user = User
      $scope.checklists = _.map data, (checklist) ->
        checklist.progbar = progbar(checklist)
        checklist
      $rootScope.active_count = $scope.checklists.length
      $scope.loaded = true

  , (data) ->
      # Error
      $scope.error = "Error retrieving information from server"

  success = (data) ->
      # Success
      $scope.user = User
      $scope.checklists = _.map data, (checklist) ->
        checklist.progbar = progbar(checklist)
        checklist
      $rootScope.active_count = $scope.checklists.length
      $scope.loaded = true

  nope = (data) ->
    $scope.error = "Error retrieving information from server"

  $scope.getChecklists = ->
    if $scope.display.inProgress && $scope.display.archived
      Checklists.all_lists {}, success, nope
    else if $scope.display.inProgress
      Checklists.query {}, success, nope
    else if $scope.display.archived
      Checklists.archived {}, success, nope
    else
      $scope.loaded = false

  $scope.categories = ChecklistCategories.query {}

  $scope.categoriesSelected = "all categories"

  $scope.categorySelected = (index) ->
    $scope.categoriesSelected = _.map(
      _.filter($scope.categories, (category) -> category.selected)
      , (category) -> category.name || "(no name)")
     .join(", ") || "all categories"

  $scope.allActive = $scope.checklists

  console.debug 'TemplatesActiveIndexCtrl', 'Initializing...'

  #$('ul.nav li').removeClass 'active'
  #$('ul.nav li#checklists_active').addClass 'active'

  progbar = (checklist) ->
    return false if checklist.finished_count == 0
    {
      width: "calc(" + Math.round((checklist.finished_count / checklist.entry_count) * 133) + "% + 0.75em)"
    }

  $scope.openChecklist = (checklist_id) ->
    $location.path("/checklists/#{checklist_id}")

  $scope.confirmDeleteChecklist = (checklist) ->
    modalInstance = $modal.open
      templateUrl: '<%= asset_path("partials/checklist_delete.html") %>'
      controller: ChecklistDeleteCtrl
      resolve:
        checklist: ->
          checklist

    modalInstance.result.then () ->
      $scope.deleteChecklist(checklist)

  $scope.deleteChecklist = (checklist) ->
    Checklists.delete {id: checklist.id},
      (data) ->
        # Success
        index = $scope.checklists.indexOf(checklist)
        $scope.checklists.splice(index,1)
        $rootScope.active_count = $scope.checklists.length
    , (data) ->
        # Error
        $scope.error = "Error deleting checklist '#{checklist.name}'"
        _.each(data.data.errors , (e,i) ->
            $scope.error = $scope.error + "<li>#{i} #{e}</li>"
          )

  $scope.clearError = ->
    $scope.error = null

  $scope.$watch "search", (value) ->
    if value
      $scope.checklists = _.filter($scope.allActive, (c) ->
          name = c.name.toLowerCase()
          ticket = c.ticket_number || ""
          name.indexOf(value.toLowerCase()) != -1 || ticket.toString().indexOf(value.toLowerCase()) != -1
        )
    else
      $scope.checklists = $scope.allActive
  , true
